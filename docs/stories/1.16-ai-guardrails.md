# Story 1.16: Document Architectural Guardrails for AI Agents

**Epic**: Epic 1 - Eliminate Circular Dependency Patterns
**Priority**: P2
**Effort**: 4 hours
**Status**: ✅ Complete

---

## User Story

As an AI agent (or future developer),
I want clear architectural guardrails that prevent circular patterns,
so that I don't enter infinite loops when making changes.

---

## Dependencies

- ✅ Stories 1.1-1.15 (all fixes must be complete)

---

## Acceptance Criteria

- [x] `docs/AI-AGENT-GUARDRAILS.md` created with:
  - [x] Red flags that indicate circular pattern entry
  - [x] Required validation steps before position-related changes
  - [x] Testing checklist (plan + 4 elevations + 3D)
  - [x] Feature flag rules
  - [x] Coordinate system transformation rules
- [x] CLAUDE.md updated with references to guardrails
- [x] README.md updated with guardrails link (discoverable)
- [x] Examples of correct vs incorrect fix approaches

---

## Integration Verification

- [x] IV1: New AI agent can read guardrails and understand circular patterns
- [x] IV2: Guardrails reference Winston's analysis and fix plans
- [x] IV3: Documentation is discoverable (linked from README.md and CLAUDE.md)

---

## Implementation Reference

See [brownfield-architecture.md](../brownfield-architecture.md) - Appendix C: AI Agent Guidance

Full details: [prd.md](../prd.md) Section 4, Story 1.16

---

## Session Folder

Create: `docs/session-2025-MM-DD-story-1.16-ai-guardrails/`

---

## Completion Checklist

- [x] All Acceptance Criteria met
- [x] All Integration Verification steps passed
- [ ] Documentation reviewed by user
- [ ] Changes committed to git
- [x] Story marked as ✅ Complete in this file

---

## Dev Agent Record

### Files Created

**Created:**
- `docs/AI-AGENT-GUARDRAILS.md` - Comprehensive AI agent guardrails (450+ lines)

**Modified:**
- `CLAUDE.md` - Added guardrails reference in Authoritative Documentation section
- `docs/README.md` - Added AI Agent Guardrails section with prominent warnings

### Document Contents

**AI-AGENT-GUARDRAILS.md includes:**

1. **Quick Reference: Red Flags** - 8 immediate warning signs
   - Asymmetric left/right calculations
   - Hardcoding Z positions
   - Bypassing transform engine
   - Creating new position calculation functions
   - Ignoring database Z positions
   - Making changes without tests
   - Trusting database door_count
   - Creating circular dependencies

2. **The NEW UNIFIED SYSTEM** - Core principles
   - CoordinateTransformEngine usage
   - ComponentService.getZPosition()
   - PositionCalculation wrappers
   - CornerCabinetDoorMatrix

3. **Circular Patterns Fixed** - All 5 patterns documented
   - Asymmetric left/right calculations
   - Height property confusion
   - Type/schema mismatch
   - Door count/width logic
   - Corner door orientation

4. **Validation Steps** - 6-step process before changes
5. **Testing Checklist** - Unit, integration, element, edge case tests
6. **Coordinate System Rules** - Axis definitions and transform flow
7. **Feature Flag Rules** - Development only, not production
8. **Examples** - Correct vs incorrect approaches (4 examples)
9. **When to Ask for Help** - 6 scenarios requiring user input
10. **Decision Tree** - Quick decision-making flowchart
11. **Critical Files** - Core infrastructure files with test coverage

### Integration Points

**Guardrails now discoverable from:**
- CLAUDE.md (Authoritative Documentation section)
- docs/README.md (AI Agent Guardrails section)
- Prominent warnings with ⚠️ emoji
- Links from multiple entry points

### Key Principles Documented

1. **Always use CoordinateTransformEngine** for coordinate transformations
2. **Always use ComponentService.getZPosition()** for Z positions
3. **Never hardcode position calculations** in rendering code
4. **Always write tests** before modifying position logic
5. **Ignore database door_count** (use width-based logic)
6. **Follow the door matrix** for corner cabinets
7. **Validate in all 6 views** (plan + 4 elevations + 3D)
8. **Ask user when unsure** (better than creating circular patterns)

### Completion Date

2025-10-27
